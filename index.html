<!DOCTYPE html>
<html lang="en">
<head>
    <title>喜报生成器</title>
    <meta charset="UTF-8">
    <link href="favicon.png" rel="shortcut icon" type="image/x-icon"/>
    <style>
        :root {
            --background-color: #f4f7f9;
            --main-color: #1e90ff;
            --font-color: #333;
            --sidebar-width: 320px;
        }

        * {
            box-sizing: border-box;
        }

        html {
            color: var(--font-color);
            background: var(--background-color);
            font: 14px 'PingFang SC', 'Helvetica Neue', Arial, 'Microsoft YaHei', sans-serif;
        }

        body {
            margin: 0;
            padding: 0 20px;
            max-width: 1100px;
            margin: 0 auto;
        }

        header {
            padding: 40px 0 20px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.1em;
            opacity: 0.6;
        }

        .view-box {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .draw-box {
            flex: 1;
            min-width: 300px;
            background: #d7dfe6;
            padding: 20px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .draw-content-box {
            background: #fff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            overflow: hidden;
            max-width: 100%;
        }

        #canvas {
            max-width: 100%;
            height: auto;
            display: block;
        }

        .setting-box {
            width: var(--sidebar-width);
            padding: 10px;
        }

        .setting-box h2 {
            font-size: 1.5em;
            margin-bottom: 20px;
        }

        .text-list .item {
            margin-bottom: 20px;
        }

        .ui-input {
            width: 100%;
            border: 2px solid #ddd;
            border-radius: 6px;
            padding: 12px;
            font-size: 16px;
            transition: border-color 0.2s;
            resize: vertical;
        }

        .ui-input:focus {
            border-color: var(--main-color);
            outline: none;
        }

        .cover-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 25px;
        }

        .cover-list img {
            width: 100%;
            aspect-ratio: 4/3;
            object-fit: cover;
            border-radius: 6px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
        }

        .cover-list img.active {
            border-color: var(--main-color);
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(30, 144, 255, 0.3);
        }

        .ui-btn {
            width: 100%;
            font-size: 18px;
            font-weight: bold;
            padding: 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.1s, background 0.2s;
        }

        .ui-btn.blue {
            background: var(--main-color);
            color: #fff;
        }

        .ui-btn:active {
            transform: scale(0.98);
        }

        @media (max-width: 768px) {
            .view-box {
                flex-direction: column;
            }
            .setting-box {
                width: 100%;
            }
            header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>

<header>
    <h1>「喜报生成器」</h1>
    <p>支持自定义文本，一键生成喜报/悲报图片</p>
</header>

<main>
    <div class="view-box">
        <div class="draw-box">
            <div class="draw-content-box">
                <canvas id="canvas" width="1292" height="969"></canvas>
            </div>
        </div>
        <div class="setting-box">
            <h2>输入文字生成喜报</h2>
            <div class="text-list">
                <div class="item">
                    <textarea id="textInput" class="ui-input" rows="4" placeholder="嘻嘻哈哈"></textarea>
                </div>
            </div>
            <div class="cover-list" id="templateList">
                <img src="xibao.webp" data-type="xibao" class="active" alt="喜报" title="点击切换喜报"/>
                <img src="beibao.webp" data-type="beibao" alt="悲报" title="点击切换悲报"/>
            </div>
            <button id="downloadBtn" class="ui-btn blue">导出图片</button>
        </div>
    </div>
</main>

<footer></footer>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const textInput = document.getElementById('textInput');
    const templateList = document.getElementById('templateList');
    const downloadBtn = document.getElementById('downloadBtn');

    const config = {
        fontFamily: "'PingFang SC', 'Helvetica Neue', Arial, 'Microsoft YaHei', sans-serif",
        templates: {
            xibao: {
                color: '#ff0000',
                strokeColor: '#fcf88d',
                strokeSize: 12,
                fontSize: 108,
            },
            beibao: {
                color: '#2d2d2d',
                strokeColor: '#ffffff',
                strokeSize: 12,
                fontSize: 108,
            }
        }
    };

    let curType = 'xibao';
    const imageCache = new Map();

    /**
     * Loads an image from a URL and caches it.
     */
    function loadImage(src) {
        if (imageCache.has(src)) return Promise.resolve(imageCache.get(src));
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = 'Anonymous';
            img.onload = () => {
                imageCache.set(src, img);
                resolve(img);
            };
            img.onerror = reject;
            img.src = src;
        });
    }

    let isDrawing = false;

    /**
     * Throttles drawing calls using requestAnimationFrame for better performance.
     */
    function requestDraw() {
        if (isDrawing) return;
        isDrawing = true;
        requestAnimationFrame(() => {
            draw();
            isDrawing = false;
        });
    }

    async function draw() {
        const typeConfig = config.templates[curType];
        const text = textInput.value || "";

        try {
            const img = await loadImage(`${curType}.webp`);

            // Clear canvas and draw background template
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

            // Configure text styles based on the selected template
            ctx.font = `bold ${typeConfig.fontSize}px ${config.fontFamily}`;
            ctx.fillStyle = typeConfig.color;
            ctx.strokeStyle = typeConfig.strokeColor;
            ctx.lineWidth = typeConfig.strokeSize;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.lineJoin = 'round';

            // Calculate vertical positioning for multi-line text
            const lines = text.split('\n');
            const lineHeight = typeConfig.fontSize * 1.2;
            const totalHeight = lines.length * lineHeight;
            let startY = canvas.height / 2 - (totalHeight / 2) + (lineHeight / 2);

            lines.forEach((line, index) => {
                const y = startY + index * lineHeight;
                ctx.strokeText(line, canvas.width / 2, y);
                ctx.fillText(line, canvas.width / 2, y);
            });
        } catch (err) {
            console.error('Failed to draw canvas:', err);
        }
    }

    // Template selection with event delegation
    templateList.addEventListener('click', (e) => {
        const target = e.target.closest('img');
        if (!target) return;

        curType = target.dataset.type;

        // Update UI active state
        templateList.querySelectorAll('img').forEach(img => img.classList.remove('active'));
        target.classList.add('active');

        requestDraw();
    });

    // Re-draw when input changes
    textInput.addEventListener('input', requestDraw);

    // Export canvas as PNG image
    downloadBtn.addEventListener('click', () => {
        canvas.toBlob((blob) => {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = `${curType}_${Date.now()}.png`;
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);
        }, 'image/png');
    });

    // Initial draw on page load
    window.addEventListener('DOMContentLoaded', requestDraw);
</script>
</body>
</html>
